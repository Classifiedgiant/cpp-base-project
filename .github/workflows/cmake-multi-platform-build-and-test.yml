# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: CMake on multiple platforms

on:
  workflow_call:
    inputs:
      create_package:
        required: true
        type: boolean
      package_tag:
        required: false
        type: string
        default: "not_set"

  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]


jobs:

  build-and-test:
    runs-on: ${{ matrix.os }}

    strategy:
      # Set fail-fast to false to ensure that feedback is delivered for all matrix combinations. Consider changing this to true when your workflow is stable.
      fail-fast: false
      matrix:
        # Original values
        #os: [ubuntu-latest, windows-latest]
        # build_type: [Release]
        #c_compiler: [gcc, clang, cl]
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl

    steps:
    - uses: actions/checkout@v3

    - name: Checkout latest
      run: git pull --tags

    - name: Install Conan
      id: conan
      uses: turtlebrowser/get-conan@main

    - name: Install Conan Dependencies
      # Window only config at the moment
      run: >
        conan profile detect &&
        conan install ${{ github.workspace }} --build=missing

    - name: Configure CMake
      run: >
        cmake --preset conan-default

    - name: Build
      run: cmake --build --preset conan-release

    - name: Create Package
      if: ${{ success() && inputs.create_package }}
      run: cpack --config ${{github.workspace}}\build\CPackConfig.cmake

    - uses: ncipollo/release-action@v1
      name: Upload Package
      if: ${{ success() && inputs.create_package }}
      with:
        artifacts: "${{ github.workspace }}/*.zip"
        body: "Testing where this appears"
        tag: ${{ inputs.package_tag }}
        replacesArtifacts: true
